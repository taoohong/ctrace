- [eBPFå…¥é—¨ï¼ˆæ•´ç†ä¸­...ï¼‰](#ebpf%E5%85%A5%E9%97%A8%E6%95%B4%E7%90%86%E4%B8%AD)
- [æ¶æ„ã€å·¥ä½œåŸç†](#%E6%9E%B6%E6%9E%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86)
  - [](#)
- [åŸºç¡€çŸ¥è¯†](#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86)
  - [kprobes](#kprobes)
  - [ELFæ–‡ä»¶æ ¼å¼](#elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F)
    - [è·Ÿè¸ªä¸åŒçš„ç¼–ç¨‹è¯­è¨€](#%E8%B7%9F%E8%B8%AA%E4%B8%8D%E5%90%8C%E7%9A%84%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80)
- [å¸¸è§eBPFç¨‹åºç±»å‹](#%E5%B8%B8%E8%A7%81ebpf%E7%A8%8B%E5%BA%8F%E7%B1%BB%E5%9E%8B)
  - [è·Ÿè¸ªç±»](#%E8%B7%9F%E8%B8%AA%E7%B1%BB)
    - [è¿½è¸ªï¼štracepointã€kprobe/uprobeã€USDT](#%E8%BF%BD%E8%B8%AAtracepointkprobeuprobeusdt)
    - [æ”¶é›†ï¼š**ftraceã€**perf_eventã€eBPF](#%E6%94%B6%E9%9B%86ftraceperf_eventebpf)
    - [system call](#system-call)
  - [ç½‘ç»œç±»](#%E7%BD%91%E7%BB%9C%E7%B1%BB)
    - [**XDPï¼ˆeXpress Data Pathï¼Œé«˜é€Ÿæ•°æ®è·¯å¾„ï¼‰ç¨‹åº**](#xdpexpress-data-path%E9%AB%98%E9%80%9F%E6%95%B0%E6%8D%AE%E8%B7%AF%E5%BE%84%E7%A8%8B%E5%BA%8F)
    - [**TCï¼ˆTraffic Controlï¼‰ç¨‹åº**](#tctraffic-control%E7%A8%8B%E5%BA%8F)
    - [**å¥—æ¥å­—ç¨‹åº**](#%E5%A5%97%E6%8E%A5%E5%AD%97%E7%A8%8B%E5%BA%8F)
    - [**cgroup ç¨‹åº**](#cgroup-%E7%A8%8B%E5%BA%8F)
- [ç¨‹åºç»„æˆ](#%E7%A8%8B%E5%BA%8F%E7%BB%84%E6%88%90)
  - [ç¨‹åºä¸‰è¦ç´ ](#%E7%A8%8B%E5%BA%8F%E4%B8%89%E8%A6%81%E7%B4%A0)
  - [LLVM å·¥å…·æŸ¥çœ‹eBPF bytecode](#llvm-%E5%B7%A5%E5%85%B7%E6%9F%A5%E7%9C%8Bebpf-bytecode)
- [ğŸ’»ç¼–ç¨‹æ¥å£](#%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3)
  - [è¯­æ³•](#%E8%AF%AD%E6%B3%95)
    - [**BPF_PERF_OUTPUT**](#bpf_perf_output)
  - [BPFé’©å­](#bpf%E9%92%A9%E5%AD%90)
    - [ç³»ç»Ÿè°ƒç”¨](#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8)
  - [BPF map](#bpf-map)
  - [è¾…åŠ©å‡½æ•°](#%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0)
    - [æŸ¥æ‰¾è¾…åŠ©å‡½æ•°](#%E6%9F%A5%E6%89%BE%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0)
  - [libbpfç¼–è¯‘](#libbpf%E7%BC%96%E8%AF%91)
  - [BTF](#btf)
  - [CORE](#core)
- [Linux namespace](#linux-namespace)
- [æŸ¥è¯¢åˆ—è¡¨](#%E6%9F%A5%E8%AF%A2%E5%88%97%E8%A1%A8)
  - [å½“å‰ç³»ç»Ÿæ”¯æŒçš„è¾…åŠ©å‡½æ•°](#%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E6%94%AF%E6%8C%81%E7%9A%84%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0)
  - [HASHæ˜ å°„](#hash%E6%98%A0%E5%B0%84)
  - [SECå®](#sec%E5%AE%8F)
- [libbpf-boostrap](#libbpf-boostrap)
- [èµ„æ–™](#%E8%B5%84%E6%96%99)
  - [å…¥é—¨](#%E5%85%A5%E9%97%A8)

# eBPFå…¥é—¨ï¼ˆæ•´ç†ä¸­...ï¼‰

- è·Ÿè¸ªï¼ˆtraceï¼‰ï¼šåŸºäºäº‹ä»¶é©±åŠ¨
- é‡‡æ ·ï¼ˆsamplingï¼‰ï¼šæ¯éš”ä¸€æ®µæ—¶é—´é‡‡æ ·ä¸€æ¬¡ï¼Œæ¯”è·Ÿè¸ªå¼€é”€å°ï¼Œ å› ä¸ºç›¸å½“äºæŠ½æ ·
- å¯è§‚æµ‹æ€§ï¼ˆobservabilityï¼‰ï¼šæ˜¯æŒ‡é€šè¿‡å…¨é¢è§‚æµ‹æ¥ç†è§£ä¸€ä¸ªç³»ç»Ÿã€‚å¯è§‚æµ‹æ€§å·¥å…·åŒ…æ‹¬è·Ÿè¸ªå·¥å…·ã€é‡‡æ ·å·¥å…·ã€åŸºäºå›ºå®šè®¡æ•°å™¨çš„å·¥å…·ï¼Œä½†ä¸åŒ…æ‹¬benchmarkå·¥å…·ï¼Œå› ä¸ºbenchmarkä¼šæ”¹å˜ç³»ç»ŸçŠ¶æ€ã€‚

- ç”¨æˆ·ç©ºé—´ APIï¼ˆuser space API for applicationsï¼‰Â `libbpf`ã€‚è¿™æ˜¯ä¸€ä¸ª C åº“ï¼Œæ¥ç®¡äº†æ‰€æœ‰åŠ è½½å·¥ä½œï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸éœ€è¦è‡ªå·±å¤„ç†å¤æ‚çš„åŠ è½½è¿‡ç¨‹äº†ã€‚
- CO-REï¼ˆCompile-Once Run-Everywhereï¼Œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œï¼‰
  - BTFï¼šBPF ç±»å‹æ ¼å¼ï¼Œå®ƒæä¾›ç»“æ„ä¿¡æ¯ä»¥é¿å…Clang å’Œå†…æ ¸å¤´æ–‡ä»¶ä¾èµ–ã€‚
  - CO-REï¼šå®ƒä½¿å·²ç¼–è¯‘çš„BPF å­—èŠ‚ç å¯é‡å®šä½ï¼Œä»è€Œé¿å…äº†LLVM é‡æ–°ç¼–è¯‘çš„éœ€è¦ã€‚LLVM å’ŒClangç¼–è¯‘åçš„ç»“æœæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ELF äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«é¢„ç¼–è¯‘çš„BPF å­—èŠ‚ç ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œã€‚BCC é¡¹ç›®ä¸­çš„å¤§éƒ¨åˆ†å·¥å…·å·²ç»å®ŒæˆåŸºäºCO-RE çš„é‡å†™ã€‚
- fast pathï¼šå¿«é€Ÿæ”¶å‘åŒ…è·¯å¾„
- ä»ä½ç‰ˆæœ¬åˆ°é«˜ç‰ˆæœ¬çš„å…¼å®¹æ€§å¯ä»¥ç”¨CO-REè§£å†³ï¼ˆCO-REåªåœ¨æ–°ç‰ˆæœ¬å†…æ ¸æ‰æ”¯æŒï¼‰ï¼Œè€Œåè¿‡æ¥å°±éœ€è¦åœ¨eBPFå†…éƒ¨åŠ ä¸Šé¢å¤–çš„ä»£ç æ¥å¤„ç†äº†ã€‚æ¯”å¦‚æ ¹æ®å†…æ ¸ç‰ˆæœ¬ä½œæ¡ä»¶ç¼–è¯‘ï¼Œä½ç‰ˆæœ¬å†…æ ¸æ‰§è¡Œä¸åŒçš„é€»è¾‘ã€‚

# æ¶æ„ã€å·¥ä½œåŸç†

- å°½ç®¡ eBPF ç¨‹åºåœ¨å†…æ ¸æ€è¿è¡Œï¼Œä½†æ˜¯è·Ÿ kernel module ä¸ä¸€æ ·ï¼ŒeBPF ç¨‹åºä¸èƒ½è°ƒç”¨æ™®é€šå†…æ ¸ export å‡ºæ¥çš„å‡½æ•°ï¼Œè€Œæ˜¯åªèƒ½è°ƒç”¨åœ¨å†…æ ¸ä¸­ä¸º eBPF äº‹å…ˆå®šä¹‰å¥½çš„ä¸€äº›æ¥å£å‡½æ•°ã€‚è¿™äº›æ¥å£å‡½æ•°å«ä½œ BPF Helpersï¼ˆBPFè¾…åŠ©å‡½æ•°ï¼‰

![Untitled](../picture/Untitled.png)

> eBPF ä½¿ç”¨ä¸cBPF ç›¸åŒï¼Œéƒ½æ˜¯åŸºäºäº‹ä»¶é©±åŠ¨æ¶æ„ã€‚ eBPF è§¦å‘çš„é’©å­ç‚¹å¯ä»¥ä¸ºï¼š 
> â€¢ç”¨æˆ·ç©ºé—´ä»£ç çš„è°ƒç”¨ 
> â€¢å†…æ ¸ä¾‹ç¨‹åœ¨ç‰¹å®šå†…å­˜åœ°å€çš„æ‰§è¡Œ 
> â€¢ç½‘ç»œæ•°æ®åŒ…çš„åˆ°è¾¾æˆ–è€…æ•°æ®åŒ…æµè½¬è·¯å¾„ä¸Š 
> â€¢ç³»ç»Ÿè°ƒç”¨ 
> â€¢...... 
> åœ¨è§¦å‘ç‚¹æ¡ä»¶æ»¡è¶³æ—¶ï¼Œåˆ™ä¼šè§¦å‘eBPF ç¨‹åºçš„è¿è¡Œã€‚

![Untitled](../picture/Untitled 1.png)

![Untitled](../picture/Untitled 2.png)

1. ç¼–è¯‘ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ LLVM æˆ–è€… GCC å·¥å…·å°†ç¼–å†™çš„ eBPF ä»£ç ç¨‹åºç¼–è¯‘æˆ eBPF å­—èŠ‚ç ï¼› 

2. åŠ è½½ï¼šç„¶åä½¿ç”¨åŠ è½½ç¨‹åº Loader é€šè¿‡ bpf() ç³»ç»Ÿè°ƒç”¨å°†å­—èŠ‚ç åŠ è½½è‡³å†…æ ¸ï¼› 

3. éªŒè¯ï¼šå†…æ ¸ä½¿ç”¨éªŒè¯å™¨ï¼ˆVerfierï¼‰ ç»„ä»¶ä¿è¯æ‰§è¡Œå­—èŠ‚ç çš„å®‰å…¨æ€§ï¼Œä»¥é¿å…å¯¹å†…æ ¸é€ æˆç¾éš¾ï¼Œåœ¨ ç¡®è®¤å­—èŠ‚ç å®‰å…¨åå°†å…¶åŠ è½½å¯¹åº”çš„å†…æ ¸æ¨¡å—æ‰§è¡Œï¼›

   éªŒè¯è¿‡ç¨‹ï¼š

    â€¢é¦–å…ˆè¿›è¡Œæ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œç¦æ­¢å¾ªç¯ï¼›å…¶ä»– CFG éªŒè¯ã€‚

    â€¢ä»¥ä¸Šä¸€æ­¥ç”Ÿæˆçš„æŒ‡ä»¤ä½œä¸ºè¾“å…¥ï¼Œéå†æ‰€æœ‰å¯èƒ½çš„æ‰§è¡Œè·¯å¾„ã€‚å…·ä½“è¯´ å°±æ˜¯æ¨¡æ‹Ÿæ¯æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼Œè§‚å¯Ÿå¯„å­˜å™¨å’Œæ ˆçš„çŠ¶æ€å˜åŒ–ã€‚ 

4. è§¦å‘è¿è¡Œï¼šåœ¨å†…æ ¸å¯¹åº”äº‹ä»¶è§¦å‘æ—¶ï¼Œè¿è¡Œçš„ eBPF å­—èŠ‚ç ç¨‹åºï¼Œå¯é€šè¿‡ map æˆ–è€… perf_event ä¸ç”¨æˆ·æ€ç¨‹åºè¿›è¡Œæ•°æ®äº¤äº’

5. å½“ç¼–å†™å®ŒæˆBPFç¨‹åºåï¼Œé¦–å…ˆä¼šé€šè¿‡clangç”ŸæˆLLVM IRæ–‡ä»¶ï¼Œç„¶åå†ç»è¿‡LLVMç”ŸæˆBPFå­—èŠ‚ç ã€‚å­—èŠ‚ç ç»è¿‡åŠ è½½å™¨é€šè¿‡`bpf()`ç³»ç»Ÿè°ƒç”¨ï¼ˆæ³¨æ„ä»è¿™é‡Œå¼€å§‹ç”±ç”¨æˆ·æ€è¿›å…¥äº†å†…æ ¸æ€ï¼‰è¿›å…¥éªŒè¯å™¨éªŒè¯ï¼Œæœ€åé€šè¿‡JITæ‰§è¡Œã€‚

6. eBPFç¨‹åºæŒ‡ä»¤éƒ½æ˜¯åœ¨å†…æ ¸çš„ç‰¹å®šæ’æ¡©ç‚¹æ‰§è¡Œï¼Œå°†æŒ‡ä»¤åŠ è½½åˆ°å†…æ ¸æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºbpf_progå­˜å‚¨æŒ‡ä»¤ï¼Œç„¶åå°†bpf_progå’Œå†…æ ¸ä¸­çš„æ’æ¡©ç‚¹è¿›è¡Œå…³è”ï¼Œå½“æ’æ¡©ç‚¹è¢«è®¿é—®åˆ°æ—¶æ‰§è¡Œè¿™äº›æŒ‡ä»¤ã€‚

7. ä¸¾ä¸ªä¾‹å­ï¼Œä»¥kprobeä¸ºä¾‹ï¼Œé¦–å…ˆkprobeä¼šå¤åˆ¶ä¿å­˜åŸæ¥çš„ç›®æ ‡åœ°å€ï¼Œç„¶åä½¿ç”¨int3æˆ–è€…jmpæŒ‡ä»¤æ›¿æ¢æ‰å®ƒï¼Œå½“ç¨‹åºæ§åˆ¶æµæ‰§è¡Œåˆ°æ–­ç‚¹æ—¶ï¼Œæ£€æŸ¥å¦‚æœç”±kprobeæ›¿æ¢çš„ï¼Œåˆ™æ‰§è¡Œkprobeç›¸å…³æŒ‡ä»¤ï¼Œç„¶åå†æ‰§è¡ŒåŸæ¥çš„ç¨‹åºã€‚å½“kprobeç¨‹åºåœæ­¢æ—¶ï¼Œå†æŠŠåŸæ¥çš„ç›®æ ‡åœ°å€æ‹·è´å›å»ï¼Œæ¥æ¢å¤ç°åœºã€‚

## 

# åŸºç¡€çŸ¥è¯†

## kprobes

> [Linuxå†…æ ¸è°ƒè¯•æŠ€æœ¯â€”â€”kprobeä½¿ç”¨ä¸å®ç°_luckyapple1028çš„åšå®¢-CSDNåšå®¢_kprobes](https://blog.csdn.net/luckyapple1028/article/details/52972315)

kprobesæŠ€æœ¯åŒ…æ‹¬çš„3ç§æ¢æµ‹æ‰‹æ®µåˆ†åˆ«æ—¶

- kprobeï¼šé¦–å…ˆkprobeæ˜¯æœ€åŸºæœ¬çš„æ¢æµ‹æ–¹å¼ï¼Œæ˜¯å®ç°åä¸¤ç§çš„åŸºç¡€ï¼Œå®ƒå¯ä»¥åœ¨ä»»æ„çš„ä½ç½®æ”¾ç½®æ¢æµ‹ç‚¹ï¼ˆå°±è¿å‡½æ•°å†…éƒ¨çš„æŸæ¡æŒ‡ä»¤å¤„ä¹Ÿå¯ä»¥ï¼‰ã€‚å®ƒæä¾›äº†æ¢æµ‹ç‚¹çš„è°ƒç”¨å‰ã€è°ƒç”¨åå’Œå†…å­˜è®¿é—®å‡ºé”™3ç§å›è°ƒæ–¹å¼ï¼Œåˆ†åˆ«æ˜¯pre_handlerã€post_handlerå’Œfault_handlerï¼Œå…¶ä¸­pre_handlerå‡½æ•°å°†åœ¨è¢«æ¢æµ‹æŒ‡ä»¤è¢«æ‰§è¡Œå‰å›è°ƒï¼Œpost_handlerä¼šåœ¨è¢«æ¢æµ‹æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•åå›è°ƒï¼ˆæ³¨æ„ä¸æ˜¯è¢«æ¢æµ‹å‡½æ•°ï¼‰ï¼Œfault_handlerä¼šåœ¨å†…å­˜è®¿é—®å‡ºé”™æ—¶è¢«è°ƒç”¨ï¼›
- jprobeï¼šjprobeåŸºäºkprobeå®ç°ï¼Œå®ƒç”¨äºè·å–è¢«æ¢æµ‹å‡½æ•°çš„å…¥å‚å€¼
- kretprobeï¼škernel return probe ç”¨äºè·å–è¢«æ¢æµ‹å‡½æ•°çš„è¿”å›å€¼ã€‚
- 

ç”¨æˆ·ç©ºé—´å®šä¹‰çš„é™æ€è·Ÿè¸ªç‚¹ï¼ˆUser Statically Defined Tracingï¼Œç®€ç§° USDTï¼‰

## ELFæ–‡ä»¶æ ¼å¼

- [ELF æ–‡ä»¶æ ¼å¼ Â· Linux Inside ä¸­æ–‡ç‰ˆ (gitbooks.io)](https://xinqiu.gitbooks.io/linux-inside-zh/content/Theory/linux-theory-2.html)

### è·Ÿè¸ªä¸åŒçš„ç¼–ç¨‹è¯­è¨€

1. ç¬¬ä¸€ç±»æ˜¯ Cã€C++ã€Golang ç­‰ç¼–è¯‘ä¸ºæœºå™¨ç åå†æ‰§è¡Œçš„ç¼–è¯‘å‹è¯­è¨€ã€‚è¿™ç±»ç¼–ç¨‹è¯­è¨€å¼€å‘çš„ç¨‹åºï¼Œé€šå¸¸ä¼š**ç¼–è¯‘æˆ ELF æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶**ï¼ŒåŒ…å«äº†**ä¿å­˜åœ¨å¯„å­˜å™¨æˆ–æ ˆä¸­çš„å‡½æ•°å‚æ•°å’Œè¿”å›å€¼**ï¼Œå› è€Œå¯ä»¥ç›´æ¥**é€šè¿‡äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„ç¬¦å·è¿›è¡Œè·Ÿè¸ª**ã€‚

2. ç¬¬äºŒç±»æ˜¯ Pythonã€Bashã€Ruby ç­‰é€šè¿‡è§£é‡Šå™¨è¯­æ³•åˆ†æä¹‹åå†æ‰§è¡Œçš„è§£é‡Šå‹è¯­è¨€ã€‚è¿™ç±»ç¼–ç¨‹è¯­è¨€å¼€å‘çš„ç¨‹åºï¼Œæ— æ³•ç›´æ¥ä»è¯­è¨€è¿è¡Œæ—¶çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è·å–åº”ç”¨ç¨‹åºçš„è°ƒè¯•ä¿¡æ¯ï¼Œé€šå¸¸éœ€è¦è·Ÿè¸ªè§£é‡Šå™¨çš„å‡½æ•°ï¼Œå†ä»å…¶å‚æ•°ä¸­è·å–åº”ç”¨ç¨‹åºçš„è¿è¡Œç»†èŠ‚ã€‚

   æŸ¥çœ‹python USDT è·Ÿè¸ªç‚¹ï¼š`sudo bpftrace -l '*:/usr/bin/python3:*'`

3. æœ€åä¸€ç±»æ˜¯ Javaã€.Netã€JavaScript ç­‰å…ˆç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå†ç”±å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ç¼–è¯‘ä¸ºæœºå™¨ç æ‰§è¡Œçš„å³æ—¶ç¼–è¯‘å‹è¯­è¨€ã€‚åŒè§£é‡Šå‹è¯­è¨€ç±»ä¼¼ï¼Œè¿™ç±»ç¼–ç¨‹è¯­è¨€æ— æ³•ç›´æ¥ä»è¯­è¨€è¿è¡Œæ—¶çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è·å–åº”ç”¨ç¨‹åºçš„è°ƒè¯•ä¿¡æ¯ã€‚è·Ÿè¸ª JIT ç¼–ç¨‹è¯­è¨€å¼€å‘çš„ç¨‹åºæ˜¯æœ€å›°éš¾çš„ï¼Œå› ä¸º JIT ç¼–è¯‘çš„çŠ¶æ€åªå­˜åœ¨äºå†…å­˜ä¸­ã€‚

ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤§éƒ¨åˆ†ç¼–è¯‘å‹è¯­è¨€éµå¾ª `ABIï¼ˆApplication Binary Interfaceï¼‰` è°ƒç”¨è§„èŒƒï¼Œå‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼éƒ½å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ã€‚è€Œ Go 1.17 ä¹‹å‰ä½¿ç”¨çš„æ˜¯ `Plan 9` è°ƒç”¨è§„èŒƒï¼Œå‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼éƒ½å­˜æ”¾åœ¨å †æ ˆä¸­ï¼›ç›´åˆ° 1.17ï¼Œ Go æ‰ä» Plan 9 åˆ‡æ¢åˆ° ABIè°ƒç”¨è§„èŒƒã€‚

# å¸¸è§eBPFç¨‹åºç±»å‹

![Untitled](../picture/Untitled 3.png)

## è·Ÿè¸ªç±»

probeç”¨æ¥è·Ÿè¸ªå†…æ ¸æ€/ç”¨æˆ·æ€å‡½æ•°ï¼Œtracepointç”¨æ¥è·Ÿè¸ªå®šä¹‰åœ¨å†…æ ¸ç‰¹æ®Šä½ç½®ç‚¹

### è¿½è¸ªï¼štracepointã€kprobe/uprobeã€USDT

**tracepoint**

â€œtracepointâ€ æ˜¯ä¸€ç§ç¼–è¯‘åˆ°ä½ çš„ç¨‹åºä¸­çš„ä¸œè¥¿ã€‚å½“ä½¿ç”¨ç¨‹åºçš„äººï¼Œæƒ³è¦çœ‹çœ‹ tracepoint ä»€ä¹ˆæ—¶å€™å‘½ä¸­åŠæå–æ•°æ®çš„æ—¶å€™ï¼Œä»–ä»¬å¯ä»¥å…ˆ"å¯ç”¨"æˆ–"æ¿€æ´»" tracepoint ã€‚é€šå¸¸ï¼Œåœ¨ tracepoint æ²¡æœ‰è¢«æ¿€æ´»çš„æ—¶å€™ä¸ä¼šäº§ç”Ÿä»»ä½•é¢å¤–çš„å¼€é”€ï¼Œç”šè‡³åœ¨å®ƒè¢«æ¿€æ´»çš„æ—¶å€™å¼€é”€ä¹Ÿæ˜¯ç›¸å½“çš„ä½ã€‚

kprobeå¯ä»¥åœ¨å†…æ ¸å‡ ä¹ä»»æ„åœ°æ–¹æ³¨å…¥ä»£ç , ä½†åŒæ—¶å†…æ ¸åœ¨å›ºå®šä½ç½®ä¹Ÿé¢„åŸ‹äº†ä¸€äº›tracepoint, è¿™äº›tracepointå¾€å¾€æ˜¯ç²¾å¿ƒæŒ‘é€‰çš„, å³ä½¿å¯¹è¯¥æ¨¡å—äº†è§£ä¸å¤šçš„äºº, é€šè¿‡tracepointä¹Ÿèƒ½æœ‰ä¸ªå¤§è‡´äº†è§£. ä¸€èˆ¬æ¥è¯´, å†…æ ¸å‡½æ•°çš„å˜åŠ¨æ¯”è¾ƒé¢‘ç¹, tracepointåˆ™ç›¸å¯¹ç¨³å®š.

**kprobe/uprobe**

**USDT**

â€œUSDT æ¢é’ˆâ€ å’Œ â€œdtrace æ¢é’ˆ"æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œæ˜¯ç”¨æˆ·ç‰ˆçš„tracepoint

### æ”¶é›†ï¼š**ftraceã€**perf_eventã€eBPF

1. Ftrace æ”¯æŒä»Kprobesã€Tracepointsã€Uprobesæ”¶é›†æ•°æ®ã€‚

2. ä»å†…æ ¸ä¸­è·å–æ•°æ®çš„ç¬¬äºŒç§æ–¹æ³•ï¼Œæ˜¯ä½¿ç”¨Â `perf_event_open`Â ç³»ç»Ÿè°ƒç”¨ã€‚åŸç†æ˜¯ï¼š

   1. è°ƒç”¨Â `perf_event_open`Â ç³»ç»Ÿè°ƒç”¨
   2. å†…æ ¸å†™æŠŠäº‹ä»¶åˆ°ä¸€ä¸ªåœ¨ç”¨æˆ·ç©ºé—´çš„ç¯å½¢ç¼“å†²åŒºä¸­ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä»ä¸­è¯»å–æ•°æ®

   æˆ‘çŸ¥é“çš„å”¯ä¸€çš„ä¸€ä»¶äº‹æƒ…æ˜¯ï¼Œä½ å¯ä»¥ä»¥è¿™ç§æ–¹å¼è¯»å– tracepointsã€‚è¿™ä¹Ÿå°±æ˜¯æ‰§è¡ŒÂ `sudo perf trace`Â å‘½ä»¤æ—¶åšçš„äº‹æƒ…ï¼ˆæ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½æœ‰ä¸€ä¸ª tracepointsï¼‰

3. eBPFå·¥ä½œåŸç†

   1. ä½ å†™ä¸€æ®µ â€œeBPF ç¨‹åºâ€ï¼ˆé€šå¸¸æ˜¯ C è¯­è¨€ï¼Œæˆ–è€…ç”¨ä¸€ç§ç”Ÿæˆè¿™ç§ç¨‹åºçš„å·¥å…·ï¼‰
   2. è¦æ±‚å†…æ ¸æŠŠæ¢é’ˆé™„ç€åˆ° kprobe/uprobe/tracepoint/dtrace æ¢é’ˆ
   3. â€œeBPF ç¨‹åº"æŠŠæ•°æ®è¾“å‡ºåˆ°ä¸€ä¸ª eBPF map/ftrace/perf ç¼“å†²åŒº
   4. ä½ æ‹¥æœ‰äº†è‡ªå·±çš„æ•°æ®ï¼

### system call

[eBPF å¯¹äºç³»ç»Ÿè°ƒç”¨çš„åº•å±‚æ”¯æŒé‡‡ç”¨çš„æ˜¯ kprobe æœºåˆ¶](https://www.ebpf.top/post/ebpf_trace_file_open/)ï¼Œç”¨æˆ·ç©ºé—´æ‰€æœ‰çš„BPFç›¸å…³å‡½æ•°, å½’æ ¹ç»“åº•éƒ½æ˜¯å¯¹äºbpfç³»ç»Ÿè°ƒç”¨çš„åŒ…è£…

æŸ¥çœ‹å†…æ ¸æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ï¼š[syscall_64.tbl - arch/x86/entry/syscalls/syscall_64.tbl - Linux source code (v5.18-rc6) - Bootlin](https://elixir.bootlin.com/linux/v5.18-rc6/source/arch/x86/entry/syscalls/syscall_64.tbl)

- [Linux ç³»ç»ŸåŠ¨æ€è¿½è¸ªæŠ€æœ¯ä»‹ç» | arsterczâ€™s blog](https://blog.arstercz.com/introduction_to_linux_dynamic_tracing/)
- [è¯‘ï½œ2017ï½œLinux è¿½è¸ªç³»ç»Ÿ&å¦‚ä½•ç»„åˆåœ¨ä¸€èµ·çš„ â€“ Blog (jayce.github.io)](https://jayce.github.io/public/posts/trace/linux-tracing-system-fit-together/)

## ç½‘ç»œç±»

### **XDPï¼ˆeXpress Data Pathï¼Œé«˜é€Ÿæ•°æ®è·¯å¾„ï¼‰ç¨‹åº**

XDP ç¨‹åºçš„ç±»å‹å®šä¹‰ä¸º BPF_PROG_TYPE_XDPï¼Œå®ƒåœ¨ç½‘ç»œé©±åŠ¨ç¨‹åºåˆšåˆšæ”¶åˆ°æ•°æ®åŒ…æ—¶è§¦å‘æ‰§è¡Œï¼Œæ”¯æŒå¸è½½åˆ°ç½‘å¡ç¡¬ä»¶ã€‚ç”±äºæ— éœ€é€šè¿‡ç¹æ‚çš„å†…æ ¸ç½‘ç»œåè®®æ ˆï¼ŒXDP ç¨‹åºå¯ç”¨æ¥å®ç°é«˜æ€§èƒ½çš„ç½‘ç»œå¤„ç†æ–¹æ¡ˆï¼Œå¸¸ç”¨äº DDoS é˜²å¾¡ã€é˜²ç«å¢™ã€4 å±‚è´Ÿè½½å‡è¡¡ç­‰åœºæ™¯ã€‚

### **TCï¼ˆTraffic Controlï¼‰ç¨‹åº**

åœ¨ç½‘å¡é˜Ÿåˆ—æ¥æ”¶æˆ–å‘é€çš„æ—¶å€™è§¦å‘æ‰§è¡Œï¼Œè¿è¡Œåœ¨å†…æ ¸åè®®æ ˆä¸­ï¼Œå¸¸ç”¨äºæµé‡æ§åˆ¶ï¼›

### **å¥—æ¥å­—ç¨‹åº**

åœ¨å¥—æ¥å­—å‘ç”Ÿåˆ›å»ºã€ä¿®æ”¹ã€æ”¶å‘æ•°æ®ç­‰å˜åŒ–çš„æ—¶å€™è§¦å‘æ‰§è¡Œï¼Œè¿è¡Œåœ¨å†…æ ¸åè®®æ ˆä¸­ï¼Œå¸¸ç”¨äºè¿‡æ»¤ã€è§‚æµ‹æˆ–é‡å®šå‘å¥—æ¥å­—ç½‘ç»œåŒ…ã€‚å…¶ä¸­ï¼ŒBPF_PROG_TYPE_SOCK_OPSã€BPF_PROG_TYPE_SK_SKBã€BPF_PROG_TYPE_SK_MSG ç­‰éƒ½å¯ä»¥ç”¨äºå¥—æ¥å­—é‡å®šå‘ï¼›

å¥—æ¥å­— eBPF ç¨‹åºå·¥ä½œåœ¨å†…æ ¸ç©ºé—´ä¸­ï¼Œæ— éœ€æŠŠç½‘ç»œæ•°æ®å‘é€åˆ°ç”¨æˆ·ç©ºé—´å°±èƒ½å®Œæˆè½¬å‘ã€‚ä½¿ç”¨å¥—æ¥å­—æ˜ å°„è½¬å‘ç½‘ç»œåŒ…éœ€è¦ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. åˆ›å»ºå¥—æ¥å­—æ˜ å°„
2. åœ¨ BPF_PROG_TYPE_SOCK_OPS ç±»å‹çš„ eBPF ç¨‹åºä¸­ï¼Œå°†æ–°åˆ›å»ºçš„å¥—æ¥å­—å­˜å…¥å¥—æ¥å­—æ˜ å°„ä¸­ï¼›
3. åœ¨æµè§£æç±»çš„ eBPF ç¨‹åºï¼ˆå¦‚ BPF_PROG_TYPE_SK_SKB æˆ–BPF_PROG_TYPE_SK_MSG ï¼‰ä¸­ï¼Œä»å¥—æ¥å­—æ˜ å°„ä¸­æå–å¥—æ¥å­—ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨ BPF è¾…åŠ©å‡½æ•°è½¬å‘ç½‘ç»œåŒ…ï¼›
4. åŠ è½½å¹¶æŒ‚è½½ eBPF ç¨‹åºåˆ°å¥—æ¥å­—äº‹ä»¶ã€‚

### **cgroup ç¨‹åº**

![Untitled](../picture/Untitled 4.png)

# ç¨‹åºç»„æˆ

eBPF ç¨‹åºçš„é«˜å±‚æ¬¡ç»„ä»¶ï¼š

- **åç«¯**ï¼šè¿™æ˜¯åœ¨å†…æ ¸ä¸­åŠ è½½å’Œè¿è¡Œçš„ eBPF å­—èŠ‚ç ã€‚å®ƒå°†æ•°æ®å†™å…¥å†…æ ¸ map å’Œç¯å½¢ç¼“å†²åŒºçš„æ•°æ®ç»“æ„ä¸­ï¼›
- **åŠ è½½å™¨**ï¼šå®ƒå°†å­—èŠ‚ç åç«¯åŠ è½½åˆ°å†…æ ¸ä¸­ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“åŠ è½½å™¨è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå­—èŠ‚ç ä¼šè¢«å†…æ ¸è‡ªåŠ¨å¸è½½ï¼›
- **å‰ç«¯**ï¼šä»æ•°æ®ç»“æ„ä¸­è¯»å–æ•°æ®ï¼ˆç”±åç«¯å†™å…¥ï¼‰å¹¶å°†å…¶æ˜¾ç¤ºç»™ç”¨æˆ·ï¼›
- **æ•°æ®ç»“æ„**ï¼šè¿™äº›æ˜¯åç«¯å’Œå‰ç«¯ä¹‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚å®ƒä»¬æ˜¯ç”±å†…æ ¸ç®¡ç†çš„ map å’Œç¯å½¢ç¼“å†²åŒºï¼Œå¯ä»¥é€šè¿‡æ–‡ä»¶æè¿°ç¬¦è®¿é—®ï¼Œå¹¶éœ€è¦åœ¨åç«¯è¢«åŠ è½½ä¹‹å‰åˆ›å»ºï¼Œæ•°æ®ä¼šæŒç»­å­˜åœ¨ï¼Œç›´åˆ°æ²¡æœ‰æ›´å¤šçš„åç«¯æˆ–å‰ç«¯è¿›è¡Œè¯»å†™æ“ä½œï¼›

![Untitled](../picture/Untitled 5.png)

![Untitled](../picture/Untitled 6.png)

## ç¨‹åºä¸‰è¦ç´ 

eBPF Program Types å¯ä»¥å®šä¹‰å‡½æ•°åœ¨ eBPF å†…æ ¸æ€çš„ç±»å‹ã€‚

eBPF Maps å®šä¹‰äº†key/value å¯¹çš„å­˜å‚¨ç»“æ„ï¼Œæ­å»ºäº† eBPF Program ä¹‹é—´ä»¥åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„æ•°æ®äº¤æ¢çš„æ¡¥æ¢ã€‚

eBPF Helpers æ˜¯å†…æ ¸äº‹å…ˆå®šä¹‰å¥½äº†æ¥å£å‡½æ•°ï¼Œæ–¹ä¾¿ eBPF ç¨‹åºè°ƒç”¨è¿™äº›å‡½æ•°ã€‚

## LLVM å·¥å…·æŸ¥çœ‹eBPF bytecode

- ç”¨objdumpæ¥æŸ¥çœ‹bpf_program.oé‡Œçš„æ±‡ç¼–æŒ‡ä»¤

`llvm-objdump -D src/bpf_program.o`

![Untitled](../picture/Untitled 7.png)

- ç”¨readelfè¯»åˆ°bpf_program.oä¸­çš„ELF sectionä¿¡æ¯ã€‚

`llvm-readelf -sections src/bpf_program.o`

![Untitled](../picture/Untitled 8.png)

# ğŸ’»ç¼–ç¨‹æ¥å£

man bpfç¿»è¯‘ï¼š[BPFä¹‹è·¯ä¸€bpfç³»ç»Ÿè°ƒç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)](https://www.anquanke.com/post/id/263803)

## è¯­æ³•

### **BPF_PERF_OUTPUT**

æ¥å®šä¹‰ä¸€ä¸ª Perf äº‹ä»¶ç±»å‹çš„ BPF æ˜ å°„ï¼Œä½¿ç”¨`perf_submit()` æŠŠæ•°æ®æäº¤åˆ°BPF æ˜ å°„

```go
åœ¨ BCC ä¸­ï¼Œä¸ eBPF ç¨‹åºä¸­ BPF_PERF_OUTPUT ç›¸å¯¹åº”çš„ç”¨æˆ·æ€è¾…åŠ©å‡½æ•°æ˜¯open_perf_buffer() ã€‚å®ƒéœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºå¤„ç†ä» Perf äº‹ä»¶ç±»å‹çš„ BPFæ˜ å°„ä¸­è¯»å–åˆ°çš„æ•°æ®ï¼Œ

b["events"].open_perf_buffer(print_event)
while 1:
try:
	b.perf_buffer_poll()
except KeyboardInterrupt:
	exit()

open_perf_buffer å®šä¹‰äº†åä¸º â€œeventsâ€ çš„ Perf äº‹ä»¶æ˜ å°„ï¼Œè€Œåé€šè¿‡
ä¸€ä¸ªå¾ªç¯è°ƒç”¨ perf_buffer_poll è¯»å–æ˜ å°„çš„å†…å®¹ï¼Œå¹¶æ‰§è¡Œå›è°ƒå‡½æ•°è¾“å‡ºè¿›ç¨‹ä¿¡æ¯ã€‚
```

## BPFé’©å­

```bash
# æŸ¥è¯¢æ‰€æœ‰å†…æ ¸æ’æ¡©å’Œè·Ÿè¸ªç‚¹
sudo bpftrace -l
# ä½¿ç”¨é€šé…ç¬¦æŸ¥è¯¢æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªç‚¹
sudo bpftrace -l 'tracepoint:syscalls:*'
# ä½¿ç”¨é€šé…ç¬¦æŸ¥è¯¢æ‰€æœ‰åå­—åŒ…å«"execve"çš„è·Ÿè¸ªç‚¹
sudo bpftrace -l '*execve*'
```

### ç³»ç»Ÿè°ƒç”¨

äº‹ä»¶åŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨

```c
#include <linux/bpf.h>
int bpf(int cmd, union bpf_attr *attr, unsigned int size);
ç¬¬ä¸€ä¸ªï¼Œcmd ï¼Œä»£è¡¨æ“ä½œå‘½ä»¤ï¼Œæ¯”å¦‚ä¸Šä¸€è®²ä¸­æˆ‘ä»¬çœ‹åˆ°çš„ BPF_PROG_LOAD å°±æ˜¯åŠ è½½eBPF ç¨‹åºï¼›
ç¬¬äºŒä¸ªï¼Œattrï¼Œä»£è¡¨ bpf_attr ç±»å‹çš„ eBPF å±æ€§æŒ‡é’ˆï¼Œä¸åŒç±»å‹çš„æ“ä½œå‘½ä»¤éœ€è¦ä¼ å…¥ä¸åŒçš„å±æ€§å‚æ•°ï¼›
ç¬¬ä¸‰ä¸ªï¼Œsize ï¼Œä»£è¡¨å±æ€§çš„å¤§å°ã€‚
```

æŸ¥çœ‹å†…æ ¸æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ï¼š`sudo cat /sys/kernel/debug/tracing/events/syscalls`

å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™æŒ‚è½½ä¸€ä¸‹ï¼š`sudo mount -t debugfs debugfs /sys/kernel/debug`

**syscall**

[6.3.11. syscall â€” äºŒè¿›åˆ¶å®‰å…¨å­¦ä¹ ç¬”è®° 1.0.0 æ–‡æ¡£ (binhack.readthedocs.io)](https://binhack.readthedocs.io/zh/latest/os/linux/syscall/index.html)

- `do_sys_openat2()` æ˜¯ç³»ç»Ÿè°ƒç”¨ `openat()` åœ¨å†…æ ¸ä¸­çš„å®ç°
- execve() ï¼šforkä¸€ä¸ªå­è¿›ç¨‹ï¼Œåœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨execå‡½æ•°å¯åŠ¨æ–°çš„ç¨‹åºã€‚

## BPF map

HASHæ˜ å°„ç”¨äºä¸åŒè·Ÿè¸ªç‚¹ç›´æ¥æ•°æ®å…±äº«ï¼Œæ€§èƒ½äº‹ä»¶æ˜ å°„ç”¨äºç”¨æˆ·ç©ºé—´è·å–è·Ÿè¸ªç‚¹æ•°æ®

![Untitled](../picture/Untitled 9.png)

```c
BPF_HASH(name, key_type=u64,leaf_type=u64, size=10240)
// ä½¿ç”¨é»˜è®¤å‚æ•°
BPF_HASH(stats);

// ä½¿ç”¨è‡ªå®šä¹‰keyç±»å‹ï¼Œä¿æŒé»˜è®¤ leaf_type=u64, size=10240
struct key_t {
	char c[80];
};
BPF_HASH(counts, struct key_t);

// è‡ªå®šä¹‰æ‰€æœ‰å‚æ•°
BPF HASH(cpu time, uint64 t, uint64 t, 4096);
```

BPF ç³»ç»Ÿè°ƒç”¨ä¸­å¹¶æ²¡æœ‰åˆ é™¤æ˜ å°„çš„å‘½ä»¤ï¼Œè¿™æ˜¯å› ä¸º BPF æ˜ å°„ä¼šåœ¨ç”¨æˆ·æ€ç¨‹åºå…³é—­æ–‡ä»¶æè¿°ç¬¦çš„æ—¶å€™è‡ªåŠ¨åˆ é™¤ï¼ˆå³close(fd) ï¼‰ã€‚å¦‚æœä½ æƒ³åœ¨ç¨‹åºé€€å‡ºåè¿˜ä¿ç•™æ˜ å°„ï¼Œå°±éœ€è¦è°ƒç”¨ BPF_OBJ_PIN å‘½ä»¤ï¼Œå°†æ˜ å°„æŒ‚è½½åˆ°/sys/fs/bpf ä¸­ã€‚

## è¾…åŠ©å‡½æ•°

![Untitled](../picture/Untitled 10.png)

![Untitled](../picture/Untitled 11.png)

![Untitled](../picture/Untitled 12.png)

ç”±äºeBPF ç¨‹åºä¸èƒ½éšæ„è°ƒç”¨å†…æ ¸å‡½æ•°ï¼Œå› æ­¤å†…æ ¸ä¸“é—¨æä¾›eBPF ç¨‹åºå¯ä»¥è°ƒç”¨çš„è¾…åŠ©å‡½æ•°ã€‚

è¾…åŠ©å‡½æ•°ä¸å†…æ ¸ç‰ˆæœ¬å¯¹åº”å…³ç³»å‚è§ï¼š[bcc/kernel-versions.md at master Â· iovisor/bcc (github.com)](https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md)

### æŸ¥æ‰¾è¾…åŠ©å‡½æ•°

1. **[reference_guide](https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md)**ï¼Œå¸¸ç”¨çš„ã€æ¨èçš„éƒ½åˆ—åœ¨é‡Œé¢äº†ï¼Œå¿…è¯»ã€‚
2. **[bpf.h](https://github.com/torvalds/linux/blob/f40ddce8/include/uapi/linux/bpf.h)**ã€‚
3. `bpftool feature probe`ï¼Œè¿™ä¸ªå‘½ä»¤ä¹Ÿå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„è¾…åŠ©å‡½æ•°ã€‚

## libbpfç¼–è¯‘

â€¢ [https://github.com/libbpf/libbpf/blob/master/src/bpf_helpers.h](https://github.com/libbpf/libbpf/blob/master/src/bpf_helpers.h)

è¯¥å¤´æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€äº›å¸¸ç”¨çš„å®ï¼Œæ¯”å¦‚`SEC`å®å£°æ˜æ®µçš„åç§°ï¼Œ`__always_inline`å®å£°æ˜å†…è”ä»£ç ï¼Œ`__uint`ã€`__type`å’Œ`__array`ä½¿ç”¨btfåŠŸèƒ½ã€‚

1. å¼€å‘ eBPF ç¨‹åºï¼Œå¹¶æŠŠæºæ–‡ä»¶å‘½åä¸º <ç¨‹åºå>.bpf.cï¼›
2. ç¼–è¯‘ eBPF ç¨‹åºä¸ºå­—èŠ‚ç ï¼Œç„¶åå†è°ƒç”¨ bpftool gen skeleton ä¸º eBPF å­—èŠ‚ç ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶;
3. å¼€å‘ç”¨æˆ·æ€ç¨‹åºï¼Œå¼•å…¥ç”Ÿæˆçš„è„šæ‰‹æ¶å¤´æ–‡ä»¶åï¼ŒåŠ è½½ eBPF ç¨‹åºå¹¶æŒ‚è½½åˆ°ç›¸åº”çš„å†…æ ¸äº‹ä»¶ä¸­ã€‚

ç¬¬äºŒæ­¥å°±æ˜¯å¼€å‘ eBPF ç¨‹åºï¼ŒåŒ…æ‹¬å®šä¹‰å“ˆå¸Œæ˜ å°„ã€æ€§èƒ½äº‹ä»¶æ˜ å°„ä»¥åŠè·Ÿè¸ªç‚¹çš„å¤„ç†å‡½æ•°ç­‰ï¼Œè€Œå¯¹è¿™äº›æ•°æ®ç»“æ„å’Œè·Ÿè¸ªå‡½æ•°çš„å®šä¹‰éƒ½å¯ä»¥é€šè¿‡ SEC() å®å®šä¹‰æ¥å®Œæˆã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œé€šè¿‡ SEC() å®å®šä¹‰çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ä¼šæ”¾åˆ°ç‰¹å®šçš„ ELF æ®µä¸­ï¼Œè¿™æ ·åç»­åœ¨åŠ è½½ BPF å­—èŠ‚ç æ—¶ï¼Œå°±å¯ä»¥ä»è¿™äº›æ®µä¸­è·å–æ‰€éœ€çš„å…ƒæ•°æ®ã€‚

## BTF

ï¼šä¹‹å‰ä½¿ç”¨bpf_probe_readæ—¶éœ€è¦çŸ¥é“å†…æ ¸æ•°æ®ç»“æ„æ‰èƒ½ä»æ­£ç¡®çš„å†…å­˜åœ°å€ä¸­å–åˆ°æ•°æ®ï¼Œé‡‡ç”¨å¼•å…¥å¤§é‡å†…æ ¸å¤´æ–‡ä»¶ï¼Œä¸åŒå†…æ ¸çš„å¤´æ–‡ä»¶è·¯å¾„åŠå…¶æ•°æ®ç»“æ„ä¸åŒï¼Œè™½ç„¶åœ¨ç¨‹åºä¸­é‡æ–°å®šä¹‰æ•°æ®ç»“æ„å¯ä»¥æš‚æ—¶è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿå¾ˆå®¹æ˜“æŠŠä½¿ç”¨æ—§å†…æ ¸æ•°æ®ç»“æ„çš„eBPFç¨‹åºå¸¦å…¥æ–°å†…æ ¸å¯¼è‡´ä¸èƒ½è¿è¡Œã€‚

BPF ç±»å‹æ ¼å¼ï¼ˆBPF Type Format, BTFï¼‰çš„è¯ç”Ÿæ­£æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ã€‚ä»å†…æ ¸ 5.2 å¼€å§‹ï¼Œåªè¦å¼€å¯äº†CONFIG_DEBUG_INFO_BTFï¼Œåœ¨ç¼–è¯‘å†…æ ¸æ—¶ï¼Œå†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰å°±ä¼šè‡ªåŠ¨å†…åµŒåœ¨å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶ vmlinux ä¸­ã€‚å¹¶ä¸”ï¼Œä½ è¿˜å¯ä»¥å€ŸåŠ©ä¸‹é¢çš„å‘½ä»¤ï¼ŒæŠŠè¿™äº›æ•°æ®ç»“æ„çš„å®šä¹‰å¯¼å‡ºåˆ°ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­ï¼ˆé€šå¸¸å‘½åä¸º vmlinux.hï¼‰ï¼š`bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h`

[ã€è¯‘ã€‘BTFGen: è®© eBPF ç¨‹åºå¯ç§»æ¤å‘å¸ƒæ›´è¿‘ä¸€æ­¥ | æ·±å…¥æµ…å‡º eBPF](https://www.ebpf.top/post/btfgen-one-step-closer-to-truly-portable-ebpf-programs/)

## CORE

ï¼šè§£å†³äº†å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰é—®é¢˜ï¼Œæ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•è®© eBPF ç¨‹åºåœ¨å†…æ ¸å‡çº§ä¹‹åï¼Œä¸éœ€è¦é‡æ–°ç¼–è¯‘å°±å¯ä»¥ç›´æ¥è¿è¡Œã€‚

å€ŸåŠ©äº† BTF æä¾›çš„è°ƒè¯•ä¿¡æ¯ï¼Œå†é€šè¿‡ä¸‹é¢çš„ä¸¤ä¸ªæ­¥éª¤ï¼Œä½¿å¾— eBPF ç¨‹åºå¯ä»¥é€‚é…ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ï¼š

1. é€šè¿‡å¯¹ BPF ä»£ç ä¸­çš„è®¿é—®åç§»é‡è¿›è¡Œé‡å†™ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„åç§»é‡ä¸åŒçš„é—®é¢˜ï¼›
2. åœ¨ libbpf ä¸­é¢„å®šä¹‰ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­çš„æ•°æ®ç»“æ„çš„ä¿®æ”¹ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ä¸­æ•°æ®ç»“æ„ä¸å…¼å®¹çš„é—®é¢˜ã€‚

å¯¹äºæ—§ç‰ˆæœ¬çš„å†…æ ¸ï¼Œè™½ç„¶å®ƒä»¬ä¸ä¼šå†å»å†…ç½® BTF çš„æ”¯æŒï¼Œä½†å¼€æºç¤¾åŒºæ­£åœ¨å°è¯•é€šè¿‡ BTFHub ç­‰æ–¹æ³•ï¼Œä¸ºå®ƒä»¬æä¾› BTF è°ƒè¯•ä¿¡æ¯ã€‚

- [BPFçš„å¯ç§»æ¤æ€§å’ŒCO-RE (Compile Once â€“ Run Everywhereï¼‰ - charlieroro - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/charlieroro/p/14206214.html)

# Linux namespace

`pid_ns_for_children`æŒ‡å‘è¯¥è¿›ç¨‹çš„å­è¿›ç¨‹ä¼šä½¿ç”¨çš„`pid_namespace`

```c
static __always_inline u32 get_task_pid_ns_id(struct task_struct* task) {
    return task->nsproxy->pid_ns_for_children->ns.inum;
}

struct pid_namespace {
	struct idr idr;
	struct rcu_head rcu;
	unsigned int pid_allocated;
	struct task_struct *child_reaper;
	struct kmem_cache *pid_cachep;
	unsigned int level;
	struct pid_namespace *parent;
#ifdef CONFIG_BSD_PROCESS_ACCT
	struct fs_pin *bacct;
#endif
	struct user_namespace *user_ns;
	struct ucounts *ucounts;
	int reboot;	/* group exit code if this pidns was rebooted */
	struct ns_common ns;
} __randomize_layout;

struct ns_common {
	atomic_long_t stashed;
	const struct proc_ns_operations *ops;
	unsigned int inum;
	refcount_t count;
};
```

# æŸ¥è¯¢åˆ—è¡¨

## å½“å‰ç³»ç»Ÿæ”¯æŒçš„è¾…åŠ©å‡½æ•°

`bpftool feature probe`

`man bpf-helpers` æˆ–include/uapi/linux/bpf.hï¼Œæœ‰å®ƒä»¬çš„è¯¦ç»†å®šä¹‰

## HASHæ˜ å°„

`bpftool feature probe | grep map_type`

## SECå®

[https://github.com/libbpf/libbpf/blob/master/src/libbpf.c#:~:text=static const struct bpf_sec_def section_defs[] %3D {](https://github.com/libbpf/libbpf/blob/master/src/libbpf.c#:~:text=static%20const%20struct%20bpf_sec_def%20section_defs%5B%5D%20%3D%20%7B)

# libbpf-boostrap

[Building BPF applications with libbpf-bootstrap (nakryiko.com)](https://nakryiko.com/posts/libbpf-bootstrap/#libbpf-bootstrap-overview)

# èµ„æ–™

[why's blog (whysdomain.com)](https://blog.whysdomain.com/blog/427/)

[eBPF Tracing å…¥é—¨æ•™ç¨‹ä¸å®ä¾‹-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº (aliyun.com)](https://developer.aliyun.com/article/810447)

[ebpf user-space probes åŸç†æ¢ç©¶ (edony.ink)](https://www.edony.ink/deep-in-ebpf-uprobe/)

[eBPF - Hi~Roy! (hi-roy.com)](https://www.hi-roy.com/categories/ebpf/)

[Linuxè¶…èƒ½åŠ›BPFæŠ€æœ¯ä»‹ç»åŠå­¦ä¹ åˆ†äº«ï¼ˆé™„PPTï¼‰ â€“ My X Files (davidlovezoe.club)](https://davidlovezoe.club/wordpress/archives/1122)

[ebpf - éšç¬”åˆ†ç±» - charlieroro - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/charlieroro/category/1878938.html)

[Articles (cn-zh) (arthurchiao.art)](https://arthurchiao.art/articles-zh/)

[eBPFæŠ€æœ¯ä»‹ç» - åˆ˜è¾¾çš„åšå®¢ (imliuda.com)](https://imliuda.com/post/1047)

[eBPFç¼–ç¨‹æŒ‡åŒ— (qq.com)](https://mp.weixin.qq.com/s?__biz=MzI1OTY2MzMxOQ==&mid=2247499983&idx=1&sn=b39f8d896abd76bf20e2f00fba25b99d&chksm=ea77f477dd007d6182536eae2d449000686bcb083f1c1a44f32fc3560d620f8eedd495fbb756&mpshare=1&scene=23&srcid=0504hBLmQ4IAzh41QU8idu5R&sharer_sharetime=1651629114111&sharer_shareid=0d0549c2b7737766aaa735707689e90c#rd)

- [(10æ¡æ¶ˆæ¯) bcc Reference Guide ä¸­æ–‡ç¿»è¯‘_JinRong.Liangçš„åšå®¢-CSDNåšå®¢_bccæ£€æŸ¥çš„æ–¹æ³•](https://blog.csdn.net/qq_34258344/article/details/108155481)
- [é€šè¿‡eBPFå®ç°å¯¹Linuxå†…æ ¸çš„çµæ´»æ‰©å±• - è®°äº‹æœ¬ (rk700.github.io)](http://rk700.github.io/2021/10/11/ebpf-introduction/)
- [eBPFå­¦ä¹ è®¡åˆ’ â€“ My X Files (davidlovezoe.club)](https://davidlovezoe.club/wordpress/archives/862)
- [eBPF ç³»åˆ—ä¸‰ï¼šeBPF map | ä¸€æœµæµŠæµªæ˜ å¤©åœ° (vvl.me)](https://vvl.me/2021/02/eBPF-3-eBPF-map/)
- [ç»¿è‰²è®°å¿†:eBPFå­¦ä¹ ç¬”è®° (gmem.cc)](https://blog.gmem.cc/ebpf)
- è‹±æ–‡åŸç‰ˆä¹¦åœ¨çº¿ç‰ˆï¼š[BPF Performance Tools: Linux System and Application Observability (ebookreading.net)](https://ebookreading.net/detail/book/EB9780136588870)

## å…¥é—¨

- [Linux å†…æ ¸ç›‘æµ‹æŠ€æœ¯ eBPF - beihai blog (wingsxdu.com)](https://wingsxdu.com/posts/linux/ebpf/)